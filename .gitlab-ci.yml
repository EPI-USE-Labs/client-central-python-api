# This file is a template, and might need editing before it works on your project.
# Official docker image.
image: docker:latest

services:
  - docker:dind

stages:
- test
- release

analysis:
  image: nikolaik/python-nodejs
  stage: test
  script:
    - pip install bandit
    - bandit -r clientcentral/

pytest:
  image: nikolaik/python-nodejs
  stage: test
  script:
    - pip install -r requirements
    - CC_TOKEN=$CC_TOKEN pytest

release:
  image: nikolaik/python-nodejs
  stage: release
  before_script:
    - echo "nameserver 192.168.5.11" > /etc/resolv.conf
    - apt-get install -y git openssh-client
    - mkdir ~/.ssh
    - ssh-keyscan -p 22 git.labs.epiuse.com > ~/.ssh/known_hosts
    - eval `ssh-agent -s`
    - ssh-add <(echo "$DEPLOY_KEY")
  variables:
    TWINE_USERNAME: $PYPI_USER
    TWINE_PASSWORD: $PYPI_PASSWORD
  script:
    - pip install bump2version
    - pip install twine
    - npm install -g semantic-release
    - npm install -g "@semantic-release/gitlab-config"
    - npm install -g "@semantic-release/gitlab"
    - npm install -g "@semantic-release/exec"
    - npm install -g "@semantic-release/git"
    - GL_URL=git.labs.epiuse.com GL_TOKEN=$GL_TOKEN npx semantic-release
