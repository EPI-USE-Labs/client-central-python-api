default:
  image: "python:3.11-alpine"

stages:
- test
- release

analysis:
  stage: test
  before_script:
    - pip3 install bandit
  script:
    - bandit -r clientcentral/

release:
  stage: release
  variables:
    TWINE_USERNAME: $PYPI_USER
    TWINE_PASSWORD: $PYPI_PASSWORD
  before_script:
    - apk update && apk upgrade
    - apk add git
    - python3 --version
    - pip3 install pip --upgrade 
    - pip3 install twine --upgrade
    - pip3 install setuptools --upgrade
    - pip3 install wheel --upgrade
    - pip3 install Commitizen --upgrade
  script:
    - git remote set-url origin https://${CI_GIT_DEPLOY_USER}:${CI_GIT_DEPLOY_TOKEN}@git.labs.epiuse.com/SWAT/clientcentral-api-python.git
    - git config --global user.email ${GITLAB_USER_EMAIL}
    - git config --global user.name ${GITLAB_USER_NAME}
    - git fetch
    - cz bump --yes --changelog --changelog-to-stdout
    - git push --follow-tags
    - python3 setup.py sdist bdist_wheel
    - twine upload dist/*
