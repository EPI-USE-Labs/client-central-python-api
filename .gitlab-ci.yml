image: nikolaik/python-nodejs

# services:
#   - docker:dind

stages:
- test
- release

analysis:
  stage: test
  script:
    - pip3 install bandit
    - bandit -r clientcentral/

pytest:
  stage: test
  script:
    - pip3 install -r requirements
    - CC_TOKEN=$CC_TOKEN pytest

release:
  stage: release
  before_script:
    - echo "nameserver 192.168.5.11" > /etc/resolv.conf
    - apt-get update && apt-get install -y git openssh-client python3-setuptools
    - mkdir ~/.ssh
    - ssh-keyscan -p 22 git.labs.epiuse.com > ~/.ssh/known_hosts
    - eval `ssh-agent -s`
    - ssh-add <(echo "$DEPLOY_KEY")
  variables:
    TWINE_USERNAME: $PYPI_USER
    TWINE_PASSWORD: $PYPI_PASSWORD
  script:
    - pip3 install bump2version
    - npm install -g semantic-release
    - npm install -g "@semantic-release/gitlab-config"
    - npm install -g "@semantic-release/gitlab"
    - npm install -g "@semantic-release/exec"
    - npm install -g "@semantic-release/git"
    - GL_URL=git.labs.epiuse.com GL_TOKEN=$GL_TOKEN npx semantic-release
